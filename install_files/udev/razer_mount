#!/bin/sh

# Exit on error
set -e

PATH='/sbin:/bin:/usr/sbin:/usr/bin'

if [ -x /usr/bin/logger ]; then
    LOGGER=/usr/bin/logger
elif [ -x /bin/logger ]; then
    LOGGER=/bin/logger
else
    unset LOGGER
fi

# for diagnostics
if [ -t 1 -a -z "$LOGGER" ] || [ ! -e '/dev/log' ]; then
    mesg() {
        echo "$@" >&2
    }
elif [ -t 1 ]; then
    mesg() {
        echo "$@"
        $LOGGER -t "${0##*/}[$$]" "$@"
    }
else
    mesg() {
        $LOGGER -t "${0##*/}[$$]" "$@"
    }
fi

DRIVER=$1
DEVICE_ID=$2

mesg "Driver $DRIVER"
mesg "Device_ID $DEVICE_ID"

if [ ! -d /sys/bus/hid/drivers/"$DRIVER" ] ; then
	mesg "Modprobing $DRIVER"
	modprobe "$DRIVER"
	sleep 0.05
	mesg "Modprobed $DRIVER"
fi

for GENERIC_DRIVER in "razer" "hid-generic"; do
	if [ -d /sys/bus/hid/drivers/"$GENERIC_DRIVER"/"$DEVICE_ID" ] ; then
		# Unbind from hid
		mesg "Unbinding $DEVICE_ID from $GENERIC_DRIVER"
		printf '%s' "$DEVICE_ID" > /sys/bus/hid/drivers/"$GENERIC_DRIVER"/unbind
		mesg "Binding $DEVICE_ID to $DRIVER"
		printf '%s' "$DEVICE_ID" > /sys/bus/hid/drivers/"$DRIVER"/bind
		sleep 0.1
		mesg "Finished binding $DEVICE_ID"
	fi
done

if [ -d /sys/bus/hid/drivers/"$DRIVER"/"$DEVICE_ID" ] ; then
	mesg "Changing group /sys/bus/hid/drivers/$DRIVER/$DEVICE_ID/"
	chgrp -R plugdev /sys/bus/hid/drivers/"$DRIVER"/"$DEVICE_ID"/
	mesg "Changed group /sys/bus/hid/drivers/$DRIVER/$DEVICE_ID/"
fi

# Handle USB bus drivers for razerwolverine (unbind xpad/xone first)
if [ "$DRIVER" = "razerwolverine" ]; then
	# Extract USB interface from device ID (e.g., 1-4:1.0)
	USB_INTF=$(echo "$DEVICE_ID" | grep -oE '[0-9]+-[0-9]+:[0-9]+\.[0-9]+' || true)
	if [ -n "$USB_INTF" ]; then
		for USB_DRIVER in "xpad" "xone"; do
			if [ -d /sys/bus/usb/drivers/"$USB_DRIVER"/"$USB_INTF" ]; then
				mesg "Unbinding $USB_INTF from $USB_DRIVER"
				printf '%s' "$USB_INTF" > /sys/bus/usb/drivers/"$USB_DRIVER"/unbind 2>/dev/null || true
			fi
		done
		if [ -d /sys/bus/usb/drivers/razerwolverine ] && [ ! -d /sys/bus/usb/drivers/razerwolverine/"$USB_INTF" ]; then
			mesg "Binding $USB_INTF to razerwolverine"
			printf '%s' "$USB_INTF" > /sys/bus/usb/drivers/razerwolverine/bind 2>/dev/null || true
		fi
	fi
fi

